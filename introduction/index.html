<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Super Nintendo development</title>
        <link rel="stylesheet" type="text/css" href="stylesheets/reveal.css" />
        <link rel="stylesheet" type="text/css" href="stylesheets/black.css" />
    </head>
    <body>
        <div class="reveal">
            <div class="slides">
                <section>
                    <h2>
                        Super Nintendo <br/>
                        スーパーファミコン
                    </h2>
                    <h2>Development</h2>
                    <p><small>
                            <a href="https://michielvoo.github.io/SNES/introduction">michielvoo.github.io/SNES/introduction</a>
                        </small>
                    </p>
                    <aside class="notes">
                        <p>Programmer's introduction into the Super Nintendo</p>
                        <p>AKA Super Famicom (Japan)</p>
                    </aside>
                </section>
                <section>
                    <section>
                        <h2>History</h2>
                        <img src="images/introduction-sfc-press-conference.jpg" 
                            alt="Nintendo Super Famicom press conference 1988" 
                            height="400px" />
                        <aside class="notes">
                            <p>Famicom/NES very successful during the '80s</p>
                            <p>New competitors by 1988</p>
                            <p>Sega Mega Drive released in 1988</p>
                            <p>Nintendo press conference November 1988</p>
                        </aside>
                    </section>
                    <section>
                        <figure>
                            <img src="images/super-famicom.jpg"
                                alt="Super Famicom" />
                            <figcaption>
                                Super Famicom released in 1990 in Japan<br />
                                Super Nintendo released in 1992 in Europe</figcaption>
                            <!-- Source: http://www.retrotaku.com/wp-content/uploads/2010/11/Super-Famicom-Japan.jpg -->
                        </figure>
                        <aside class="notes">
                            <p>Famicom/NES very successful during the '80s</p>
                            <p>New competitors by 1988</p>
                            <p>Sega Mega Drive released in 1988</p>
                            <p>Nintendo press conference November 1988</p>
                            <p>Very soft and friendly design</p>
                            <p>Doesn't look hi-tech, but is quite advanced (but slow CPU)</p>
                            <p>Ext port moved to bottom</p>
                            <p>United States would get different (not beautiful) design, released in 1991</p>
                        </aside>
                    </section>
                    <!-- /History -->
                </section>

                <section>
                    <h2>Hardware</h2>
                    <div class="layout" style="display: flex">
                        <div class="first column" style="width: 50%">
                            <img src="images/super-famicom-pcb.png" alt="Super Famicom printed circuit board" />
                        </div>
                        <div class="last column" style="width: 50%; text-align: left; padding-left: 1em;">
                            <ul>
                                <li>3 'processing units'
                                    <ul>
                                        <li class="fragment">Central Processing Unit</li>
                                        <li class="fragment">Audio Processing Unit</li>
                                        <li class="fragment">Picture Processing Unit</li>
                                    </ul>
                                </li>
                                <li class="fragment">128KB RAM</li>
                                <li class="fragment">Memory-mapped I/O</li>
                                <li class="fragment">V/H-Blank interrupts</li>
                                <li class="fragment">DMA</li>
                            </ul>
                        </div>
                    </div>
                    <aside class="notes">
                        <p>3 subsystems</p>
                        <p>Direct access to subsystems and IO: cartridge, controller, ext port</p>
                        <p>V/H-Blank as run loop</p>
                        <p>DMA to transfer data from cart to (video) memory</li>
                    </aside>
                </section>
                <section>
                    <section>
                        <h2>S-CPU</h2>
                        <figure>
                            <img src="images/ricoh-5a22.jpg"
                                alt="Ricoh 5A22" 
                                height="256" />
                            <figcaption>Ricoh 5A22 (based on W65C816)</figcaption>
                            <!-- Source: https://en.wikipedia.org/wiki/File:5A22-02_01.jpg -->
                        </figure>
                    </section>
                    <section>
                        <h2>S-CPU</h2>
                        <ul>
                            <li class="fragment">Registers
                                <ul>
                                    <li class="fragment">3 general-purpose (A, X & Y)</li>
                                    <li class="fragment">1 status</li>
                                    <li class="fragment">2 addressing (D 0-offset and DB bank)</li>
                                    <li class="fragment">Stack pointer (S)</li>
                                    <li class="fragment">Program counter (PC)</li>
                                </ul>
                            </li>
                            <li class="fragment">8- or 16-bit registers</li>
                            <li class="fragment">24-bit address space</li>
                            <li class="fragment">6502 emulation mode</li>
                            <li class="fragment"><hr />Max 3.58 MHz</li>
                            <li class="fragment">Multiplication and division</li>
                        </ul>
                        <aside class="notes">
                            <p>D: offset for direct addressing</p>
                            <p>B: select bank 0 - 255</p>
                            <p>Register size switch at will</p>
                            <p>16MB address space, but system has 128KB RAM</p>
                            <p>6502 used in NES and Apple IIGS</p>
                            <hr />
                            <p>Relatively slow</p>
                        </aside>
                    </section>
                    <!-- /S-CPU -->
                </section>

                <section>
                    <section>
                        <h2>S-APU</h2>
                        <figure>
                            <img src="images/s-apu.jpeg"
                                alt="S-APU"
                                height="256" />
                            <figcaption>Audio Processing Unit</figcaption>
                            <!-- Source:  -->
                        </figure>
                        <aside class="notes">
                            <p>Designed by Ken Kutaragi (Sony PlayStation)</p>
                            <p>Separate PCB in early revisions</p>
                            <p>More like midi than wav</p>
                        </aside>
                    </section>
                    <section>
                        <iframe width="512" height="384" src="https://www.youtube.com/embed/RDMWp1oLoA0?start=220" frameborder="0"></iframe>
                        <p>Musical scores</p>
                        <aside class="notes">
                            <p>Using mode 7 and music to achieve cinematic effect</p>
                        </aside>
                    </section>
                    <!-- /S-APU -->
                </section>

                <section>
                    <section>
                        <h2>S-PPU</h2>
                        <figure>
                            <img src="images/s-ppu1.jpg"
                                alt="S-PPU1"
                                height="256" />
                            <figcaption>Picture Processing Unit</figcaption>
                            <!-- Source: http://retro.mmgn.com/NES/Forums/retro-repair-mod-horror-stories -->
                        </figure>
                        <aside class="notes">
                            <p>Consists of 2 processors</p>
                        </aside>
                    </section>
                    <section>
                        <div class="layout" style="display: flex">
                            <div class="first column" style="width: 50%">
                                <img src="images/super-mario-world.png"
                                    alt="Zelda"
                                    width="512" />
                                <!-- Source: http://www.ign.com/boards/threads/favourite-views-in-the-series.454221187/ -->
                            </div>
                            <div class="last column" style="width: 50%; text-align: left; padding-left: 1em;">
                                <p>240p @ 60FPS</p>
                                <p class="fragment">32K colors</p>
                                <p class="fragment">16 palettes &times; 16 colors</p>
                                <p class="fragment">4 background layers</p>
                                <p class="fragment">128 sprites (64 &times; 64)</p>
                                <p class="fragment">1 palette per sprite</p>
                            </div>
                        </div>
                        <aside class="notes">
                            <p>8 background modes</p>
                            <p>Sprites up to 64 by 64 pixels</p>
                            <p>256 pixels by 224 lines</p>
                        </aside>
                    </section>

                    <section>
                        <figure>
                            <img src="images/super-mario-world-transparency.png"
                                alt="Secret of Mana"
                                width="512" />
                            <figcaption>Color addition and subtraction</figcaption>
                            <!-- Source: http://nateewertkrocker.com/2013/03/ -->
                        </figure>
                        <aside class="notes">
                            <p>Transparency effect</p>
                            <p>Uses color addition and subtraction</p>
                        </aside>
                    </section>
                    <section>
                        <figure>
                            <img src="images/super-mario-world-flying.gif"
                                alt="Super Mario World scrolling"
                                width="512" />
                            <figcaption>Scrolling</figcaption>
                            <!-- Source: https://www.tumblr.com/search/flying%20yoshi -->
                        </figure>
                        <aside class="notes">
                            <p>Built-in effect, horizontal and vertical</p>
                            <p>Combine with V/H-Blank to create custom shapes</p>
                        </aside>
                    </section>
                    <section>
                        <figure>
                            <img src="images/super-mario-world-window-mask.gif"
                                alt="Super Mario World window mask"
                                width="512" />
                            <figcaption>Window mask</figcaption>
                            <!-- Source: ? -->
                        </figure>
                        <aside class="notes">
                            <p>Built-in effect, horizontal and vertical</p>
                            <p>Combine with V/H-Blank to create custom shapes</p>
                        </aside>
                    </section>
                    <section>
                        <figure>
                            <img src="images/super-mario-world-mosaic.gif"
                                alt="Super Mario World mosaic"
                                width="512" />
                            <figcaption>Mosaic effect</figcaption>
                            <!-- Source: http://hellyeakpokemon.tumblr.com/ -->
                        </figure>
                        <aside class="notes">
                            <p>Built-in effect, scales top-left pixels, up or down, step-wise</p>
                        </aside>
                    </section>
                    <section>
                        <figure>
                            <img src="images/super-mario-world-bowser-mode-7.gif"
                                alt="F-Zero"
                                width="512" />
                            <figcaption>Background mode 7</figcaption>
                            <!-- Source: http://www.gamingontheedge.com/2014/05/f-zero-city-of-silence.html -->
                        </figure>
                        <aside class="notes">
                            <p>Entire track is zoomed, scaled and rotated during the race</p>
                        </aside>
                    </section>
                    <!-- /S-PPU -->
                </section>

                <section>
                    <section>
                        <h2>Enhancements</h2>
                        <img src="images/super-fx-chip.jpg"
                            alt="Super FX chip"
                            width="512" />
                        <p>Installed on cartridge</p>
                        <aside class="notes">
                            <p>Embedded in cartridge</p>
                            <p>By design</p>
                            <p>Super Nintendo can yield to co-processor</p>
                            <p>Some by Nintendo, some by 3rd party publishers</p>
                            <p>Also copy-protection</p>
                        </aside>
                    </section>
                    <section>
                        <figure>
                            <img src="images/star-fox.gif"
                                alt="Star Fox"
                                width="512" />
                            <figcaption>Super FX</figcaption>
                            <!-- Source: https://giphy.com/gifs/video-games-nintendo-snes-67c6xTeKCxXqM -->
                        </figure>
                        <aside class="notes">
                            <p>16-bit RISC</p>
                            <p>Developed by Argonout Games</p>
                            <p>Argonaut Games also developed Star Fox</p>
                            <p>Draw polygons into frame buffer</p>
                            <p>DSP used by Super Mario Kart is another examples</p>
                        </aside>
                    </section>
                    <!-- /Enhancements -->
                </section>

                <section>
                    <section>
                        <h2>Tools</h2>
                        <figure>
                            <img src="images/emulator-se.jpg"
                                alt="Emulator SE"
                                height="384" />
                            <figcaption>Official development kit</figcaption>
                            <!-- Source: ? -->
                        </figure>
                        <aside class="notes">
                            <p>Used in the 90's</p>
                            <p>Very rare today</p>
                            <p>Recently on eBay for $7000 or more</p>
                            <p>Not known to work (missing software)</p>
                        </aside>
                    </section>
                    <section>
                        <h2>Alternatives</h2>
                        <figure>
                            <img src="images/super-wild-card-dx.jpg"
                                alt="Super Wild Card DX"
                                width="512" />
                            <figcaption>Un-official 'development kit'</figcaption>
                            <!-- Source: ? -->
                        </figure>
                        <aside class="notes">
                            <p>Load programs from floppy</p>
                            <p>Upload programs through parallel port</p>
                            <p>Can also dump cartridge to floppy</p>
                            <p>Mainly used for copying</p>
                            <p>Support software is mostly 16-bit Windows 95</p>
                        </aside>
                    </section>
                </section>

                <section>
                    <section>
                        <h2>Programming</h2>
                        <p>Skills and concepts</p>
                        <ul>
                            <li class="fragment">65816 assembly language</li>
                            <li  class="fragment">Memory-mapped I/O</li>
                            <li  class="fragment">Read/write ports and DMA</li>
                            <li  class="fragment">V-Blank interrupt</li>
                        </ul>
                        <aside class="notes">
                            <p>Most important</p>
                            <p>skill: assembly</p>
                            <p>concept: memory-mapped I/O</p>
                            <p>concept: V-Blank</p>
                        </aside>
                    </section>
                    <section>
                        <h2>Assembly</h2>
                        <p>Opcodes and operands</p>
                        <pre>
                            <code>01 clc                  ; Clear the CPU carry flag
02 xce                  ; Switch to 65816 native mode

03 .DEFINE CGDATA $2122 ; Use directive to define a named value

04 lda #$FF             ; Load the accumulator with the value 0xFF
05 sta CGDATA           ; Store the accumulator value in address $2121</code>
                        </pre>
                        <aside class="notes">
                            <p>Opcodes</p>
                            <p>Addressing modes</p>
                            <p>Directives</p>
                            <p>DMA</p>
                        </aside>
                    </section>
                    <section>
                        <h2>Assembly 2</h2>
                        <p>Control flow</p>
                        <pre>
                            <code><span class="fragment">01 ; Wait for joypad auto-read
02 -   lda HVBJOY
03     bit #HVBJOY_JOYREADY
04     bne -</span>
<span class="fragment">
05     rep #$20   ; Reset accumulator to 16-bit
06     lda JOY1    ; Get joypad input
07     bit #JOY_UP ; Check if up was pressed on the D-pad
08     bne Up</span>
<span class="fragment">
09     bit #JOY_DOWN ; Check if down was pressed on the D-pad
10     bne Down</span></code>
                        </pre>
                        <aside class="notes">
                            <p>Opcodes</p>
                            <p>Addressing modes</p>
                            <p>Directives</p>
                            <p>DMA</p>
                        </aside>
                    </section>
                    <section>
                        <figure>
                            <img src="images/memory-map.png"
                                alt="Super Nintendo Memory Map" />
                            <figcaption>Super Nintendo Memory Map</figcaption>
                            <!-- Source: ? -->
                        </figure>
                        <aside class="notes">
                            <p>Right to left, bottom to top</p>
                            <p>Address by bank (using CPU DB register)</p>
                            <p>Mirrored regions, sometimes different speed</p>
                            <p>Contiguous RAM in bank 7E + 7F</p>
                            <p>PPU, controller, DMA</p>
                            <p>Cartridge size is limited by map (but workarounds)</p>
                        </aside>
                    </section>
                    <section>
                        <h2>Ports</h2>
                        <p>Write color data to (CGRAM) 'through' a port</p>
                        <pre>
                            <code><span class="fragment">01 ; Set color 1 of palette 8 to white</span>
<span class="fragment">02 lda #$81          ; Load destination address</span>
<span class="fragment">03 sta CGADD         ; Set destination address (CGRAM)</span>
<span class="fragment">04 lda #$FF          ; Load value (L)</span>
<span class="fragment">05 sta CGDATA        ; Write value to port (CGRAM)</span>
<span class="fragment">06 lda #$7F          ; Load value (H)</span>
<span class="fragment">07 sta CGDATA        ; Write value to port (CGRAM)</span>
<span class="fragment">
08 ; Next color...
09 lda #$82          ; Load destination address
10 sta CGADD         ; Set destination address (CGRAM)</span></code>
                        </pre>
                        <aside class="notes">
                            <p>(CGRAM) is not mapped into address space</p>
                            <p>Palette 0, color 1 and then color 2</p>
                            <p>Example of a double-write port</p>
                            <p>Have to change the address for the next color</p>
                        </aside>
                    </section>
                    <section>
                        <h2>Ports 2</h2>
                        <p>Write pixel data to (VRAM) 'through' a port</p>
                        <pre>
                            <code><span class="fragment">01 lda #VMAINC_INC_H ; Increment after writing VMDATAH</span> 
<span class="fragment">02 sta VMAINC        ; Set VRAM increment mode</span>

<span class="fragment">03 ldx #$0400        ; Load destination address</span>
<span class="fragment">04 stx VMADD         ; Set destination address (VRAM)</span>

<span class="fragment">05 lda #%00000100    ; Load value (L)</span>
<span class="fragment">06 sta VMDATAL       ; Write value to port (VRAM)</span>
<span class="fragment">07 lda #%01110100    ; Load value (H)</span>
<span class="fragment">08 sta VMDATAH       ; Write value to port (VRAM)</span>
<span class="fragment">
09 lda #%00000111
10 sta VMDATAL       ; Address was incremented automatically to #$0401
11 lda #%00000100
12 sta VMDATAH</span></code>
                        </pre>
                        <aside class="notes">
                            <p>Set write mode (optional)</p>
                            <p>VMAINC Video Memory Address Increment Mode</p>
                            <p>Set destination address</p>
                            <p>Write data 'through' port</p>
                            <p>Don't have to change the address for consecutive bytes</p>
                            <p>Notice syntax hex vs. binary</p>
                        </aside>
                    </section>
                    <section>
                        <h2>DMA</h2>
                        <p>Transfer data between cartridge and VRAM</p>
                        <pre>
                            <code><span class="fragment">01 lda #%00000000    ; From A-bus to B-bus, read consecutive addresses</span>
<span class="fragment">02 sta DMAP0         ; Set DMA control</span>
<span class="fragment">03 lda #(CGDATA - BBUS_OFFSET)
04 sta BBAD0         ; Set DMA destination (8-bit B-bus is A-bus - $2100)</span>
<span class="fragment">05 lda #Color        ; Address of the defined bytes at the Color label
06 sta A1T0          ; Set DMA source (A-bus)</span>
<span class="fragment">07 lda #:Color       ; Get the bank of some defined bytes at the Color label
08 sta A1B0          ; Set the bank to use during DMA</span>
<span class="fragment">09 lda #$02
10 sta DAS0L         ; Set DMA transfer size (number of bytes)
11 stz DAS0H</span>
<span class="fragment">12 stz CGADD         ; Set starting address
13 lda #$01
14 sta MDMAEN        ; Initialize DMA transfer</span></code>
                        </pre>
                        <aside class="notes">
                            <p>Transfer between A-bus and B-bus</p>
                            <p>Skips (pauses) the CPU</p>
                            <p>Reason for ports in the address space</p>
                            <p>Combined with addressing modes</p>
                        </aside>
                    </section>
                    <section>
                        <h2>V-Blank interrupt</h2>
                        <p>Callback every field/frame</p>
                        <pre>
                            <code><span class="fragment">01     .SNESNATIVEVECTOR ; WLA-DX directives
02         NMI VBlank
03     .ENDNATIVEVECTOR</span>

<span class="fragment">04     ; Enable V-Blank
05     lda #NMITIMEN_NMI_ENABLE
06     sta NMITIMEN</span>

<span class="fragment">07 -   wai
08     jmp -       ; Infinite loop</span>

<span class="fragment">09 VBlank:
10     ; Callback code goes here...</span></code>
                        </pre>
                        <aside class="notes">
                            <p>50 or 60 times per second</p>
                            <p>Some time before next screen is rendered</p>
                        </aside>
                    </section>
                </section>

                <section>
                    <section>
                        <h2>Tiles</h2>
                        <ul>
                            <li>Used for backgrounds and sprites</li>
                            <li>Stored in VRAM as 'characters'</li>
                            <li>8 by 8 planar bitmaps</li>
                        </ul>
                    </section>
                    <section>
                        <h2>Planar bitmaps</h2>
                        <ul>
                            <li>2, 4 or 8 planes (layers)</li>
                            <li>1 or 0 in each plane is combined</li>
                            <li>Value determines color</li>
                        </ul>
                        <pre>
                            <code>
        Plane A
         0 | 1      Plane B
         - + -       1 | 1       Result
         1 | 0       - + -       1 | 2
                     0 | 0       - + -
                                 1 | 0
                            </code>
                        </pre>
                        <aside class="notes">
                            <p>4, 16 or 256 possible values</p>
                        </aside>
                    </section>
                    <section>
                        <h2>Sprites</h2>
                        <p>Metadata for each sprite is stored in a table</p>
                        <ul>
                            <li>X-coordinate</li>
                            <li>Y-coordinate</li>
                            <li>Character number (VRAM)</li>
                            <li>Palette number</li>
                            <li>Priority (Z-ordering)</li>
                            <li>Horizontal/vertical flip</li>
                            <li>Size</li>
                        </ul>
                        <aside class="notes">
                            <p>Size: 8, 16, 32, 64</p>
                            <p>Character number is used to determine the tiles in VRAM</p>
                        </aside>
                    </section>
                    <section>
                        <h2>Backgrounds</h2>
                        <p>Depends on background mode</p>
                        <p>Consist of tilemaps of 32 by 32 tiles</p>
                        <ul>
                            <li>Character number (VRAM)</li>
                            <li>Palette number</li>
                            <li>Priority (Z-ordering)</li>
                            <li>Horizontal/vertical flip</li>
                        </ul>
                        <aside class="notes">
                            <p>Up to 4 backgrounds, depending on mode</p>
                            <p>Size of background and tiles can be set</p>
                            <p>May require 1, 2 or 4 tilemaps</p>
                        </aside>
                    </section>
                </section>

                <section>
                    <h2>Code + demo?</h2>
                    <img src="images/demo.png" alt="Super Nintendo demo program" width="512" />
                </section>

                <section>
                    <h2>Links</h2>
                    <ul>
                        <li><a href="https://github.com/michielvoo/SNES/tree/master/examples" target="_blank">Examples</a></li>
                        <li><a href="https://github.com/michielvoo/SNES/wiki" target="_blank">Documentation</a></li>
                        <li><a href="https://github.com/vhelin/wla-dx">WLA-DX assembler</a></li>
                        <li><a href="http://byuu.org/emulation/higan/">Higan</a> (emulator)</li>
                        <li><a href="http://openemu.org/">OpenEMU</a> (emulator host)</li>
                    </ul>
                </section>
            </div>
        </div>
        <script src="scripts/head.min.js"></script>
        <script src="scripts/reveal.js"></script>
        <script>
            Reveal.initialize({
                controls: false,
                center: true,
                history: true,
                transition: 'slide',
                dependencies: [
                    {
                        src: 'plugin/notes/notes.js', 
                        async: true
                    }
                ]
            });
        </script>
</body>
</html>
